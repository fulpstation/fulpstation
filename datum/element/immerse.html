<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <base href="../../" />
    <link rel="stylesheet" href="dmdoc.css" />
    <title>&#x2F;datum&#x2F;element&#x2F;immerse - &#x2F;tg&#x2F; Station 13</title>
</head>
<body>
<header>
    <a href="index.html">&#x2F;tg&#x2F; Station 13</a> -
    <a href="index.html#modules">Modules</a> -
    <a href="index.html#types">Types</a>
 &mdash; <a href="datum/element/immerse.html#var">Var Details</a> - <a href="datum/element/immerse.html#proc">Proc Details</a></header>
<main>
<h1>immerse <aside>/<a href="datum.html">datum</a>/<a href="datum/element.html">element</a>/<a href="datum/element/immerse.html">immerse</a></aside>
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L6">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 6"/></a></h1>

<p>A visual element that makes movables entering the attached turfs look immersed into that turf.</p>
<p>Abandon all hope, ye who read forth, for this immerse works on mind-numbing workarounds,</p><table class="summary" cellspacing="0"><tr><td colspan="2"><h2>Vars</h2></td></tr>
            <tr><th><a href="datum/element/immerse.html#var/attached_turfs_and_movables">attached_turfs_and_movables</a></th><td>An association list of turfs that have this element attached and their affected contents.</td></tr>
            <tr><th><a href="datum/element/immerse.html#var/generated_immerse_icons">generated_immerse_icons</a></th><td>A list of icons generated from a target and a mask, later used as appearances for the overlays.</td></tr>
            <tr><th><a href="datum/element/immerse.html#var/generated_visual_overlays">generated_visual_overlays</a></th><td>A list of instances of /atom/movable/immerse_overlay then used as visual overlays for the immersed movables.</td></tr>
            <tr><th><a href="datum/element/immerse.html#var/immersed_movables">immersed_movables</a></th><td>An association list of movables as key and overlays as assoc.</td></tr>
            <tr><th><a href="datum/element/immerse.html#var/movables_to_ignore">movables_to_ignore</a></th><td>A list of movables that shouldn't be affected by the element, either because it'd look bad
or barely perceptible.</td></tr><tr><td colspan="2"><h2>Procs</h2></td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/Detach">Detach</a></th><td>Hello, you may be wondering why we're blending icons and not simply
overlaying one mutable appearance with the blend multiply on another.
Well, the latter option doesn't work as neatly when added
to an atom with the KEEP_TOGETHER appearance flag, with the mask icon also
showing on said atom, while we don't want it to.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/add_immerse_overlay">add_immerse_overlay</a></th><td>The main proc, which adds a visual overlay to the movable that has entered the turf to make it look immersed.
It's kind of iffy but basically, we want the overlay to cover as much area as needed to
avoid the movable's icon from spilling horizontally or below.
Also, while these visual overlays are mainly cached movables, for certain movables, such as living mobs,
we want them to have their own unique vis overlay with additional signals registered.
This allows the vis overlay to look more or less unchanged while its owner is spinning or resting
without otherwise affecting other movables with identical overlays.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/clear_overlay_refs">clear_overlay_refs</a></th><td>We need to make sure to remove hard refs from the element when deleted.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/generate_vis_overlay">generate_vis_overlay</a></th><td>Let's give an unique immerse visual only to those movables that would
benefit from this the most, for the sake of a smidge of lightweightness.
Initializes and caches a new visual overlay given parameters such as width, height and whether it should appear fully underwater.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/on_atom_exited">on_atom_exited</a></th><td>Called when a movable exits the turf. If its new location is not in the list of turfs with this element,
Remove the movable from the element.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/on_init_or_entered">on_init_or_entered</a></th><td>If the movable is within the right layers and planes, not in the list of movable types to ignore,
or already affected by the element for that matter, Signals will be registered and,
unless the movable (or whatever it's buckled to) is flying, it'll appear as if immersed in that water.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/on_move_flag_disabled">on_move_flag_disabled</a></th><td>Readds the overlay to the mob and bucklees if no longer flying.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/on_move_flag_enabled">on_move_flag_enabled</a></th><td>Removes the overlay from mob and bucklees is flying.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/on_spin_animation">on_spin_animation</a></th><td>Here, we temporarily switch from the offset of the mutable appearance to one for movable used as visual overlay.
Why? While visual overlays can be animated, their fixed point stays at the center of the icon of the atom
they're attached to and not theirs, which can make manipulating the transform var a pain, but because
we cannot do that with normal overlay or filters (reliably), we have to bend a knee and try to compensate it.
Oh, yeah, didn't I mention turning a visual overlay affects its pixel x/y/w/z too? Yeah, it sucks.
Spin the overlay in the opposite direction so it doesn't look like it's spinning at all.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/on_throw">on_throw</a></th><td>Works just like on_move_flag_enabled, except it only has to check that movable isn't flying</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/on_throw_landed">on_throw_landed</a></th><td>Works just like on_move_flag_disabled, except it only has to check that movable isn't flying</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/on_update_transform">on_update_transform</a></th><td>A band-aid to keep the (unique) visual overlay from scaling and rotating along with its owner. I'm sorry.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/remove_from_element">remove_from_element</a></th><td>Remove any signal, overlay, trait given to the movable and reference to it within the element.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/remove_immerse_overlay">remove_immerse_overlay</a></th><td>vis contents spin around the center of the icon of their vis locs
but since we want the appearance to stay where it should be,
we have to counteract this one.
This proc removes the vis_overlay, the keep together trait and some signals from the movable.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/start_immersion">start_immersion</a></th><td>Makes the element start affecting the turf and its contents. Called on Attach() or when TRAIT_IMMERSE_STOPPED is removed.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/stop_immersion">stop_immersion</a></th><td>Stops the element from affecting on the turf and its contents. Called on Detach() or when TRAIT_IMMERSE_STOPPED is added.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/try_immerse">try_immerse</a></th><td>Called by init_or_entered() and on_set_buckled().
This applies the overlay if neither the movable or whatever is buckled to (exclusive to living mobs) are flying
as well as movetype signals when the movable isn't buckled.</td></tr>
            <tr><th><a href="datum/element/immerse.html#proc/try_unimmerse">try_unimmerse</a></th><td>Called by on_set_buckled() and remove_from_element().
This removes the filter and signals from the movable unless it doesn't have them.</td></tr></table>
    <h2 id="var">Var Details</h2><h3 id="var/attached_turfs_and_movables"><aside class="declaration">var </aside>attached_turfs_and_movables
            <aside>&ndash; /list</aside>
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L10">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 10"/></a></h3>
        <p>An association list of turfs that have this element attached and their affected contents.</p><h3 id="var/generated_immerse_icons"><aside class="declaration">var </aside>generated_immerse_icons
            <aside>&ndash; /static/list</aside>
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L18">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 18"/></a></h3>
        <p>A list of icons generated from a target and a mask, later used as appearances for the overlays.</p><h3 id="var/generated_visual_overlays"><aside class="declaration">var </aside>generated_visual_overlays
            <aside>&ndash; /list</aside>
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L20">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 20"/></a></h3>
        <p>A list of instances of /atom/movable/immerse_overlay then used as visual overlays for the immersed movables.</p><h3 id="var/immersed_movables"><aside class="declaration">var </aside>immersed_movables
            <aside>&ndash; /list</aside>
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L22">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 22"/></a></h3>
        <p>An association list of movables as key and overlays as assoc.</p><h3 id="var/movables_to_ignore"><aside class="declaration">var </aside>movables_to_ignore
            <aside>&ndash; /static/list</aside>
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L16">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 16"/></a></h3>
        <p>A list of movables that shouldn't be affected by the element, either because it'd look bad
or barely perceptible.</p><h2 id="proc">Proc Details</h2><h3 id="proc/Detach"><aside class="parent"><a title="/datum/element" href="datum/element.html#proc/Detach">&uarr;</a></aside>Detach<aside>(/<a href="turf.html">turf</a>/source) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L78">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 78"/></a></aside>
        </h3>
        <p>Hello, you may be wondering why we're blending icons and not simply
overlaying one mutable appearance with the blend multiply on another.
Well, the latter option doesn't work as neatly when added
to an atom with the KEEP_TOGETHER appearance flag, with the mask icon also
showing on said atom, while we don't want it to.</p>
<p>Also using KEEP_APART isn't an option, because unless it's drawn as one with
its visual loation, the whole plane the atom belongs to will count as part of the
mask of the final visual overlay since that's how the BLEND_INSET_OVERLAY blend mode works here.
In layman terms, with KEEP_APART on, if a flying monkey gets nears an immersed
human, the visual overlay will appear on the flying monkey even if it shouldn't.</p><h3 id="proc/add_immerse_overlay"><aside class="declaration">proc </aside>add_immerse_overlay<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/movable) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L139">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 139"/></a></aside>
        </h3>
        <p>The main proc, which adds a visual overlay to the movable that has entered the turf to make it look immersed.
It's kind of iffy but basically, we want the overlay to cover as much area as needed to
avoid the movable's icon from spilling horizontally or below.
Also, while these visual overlays are mainly cached movables, for certain movables, such as living mobs,
we want them to have their own unique vis overlay with additional signals registered.
This allows the vis overlay to look more or less unchanged while its owner is spinning or resting
without otherwise affecting other movables with identical overlays.</p><h3 id="proc/clear_overlay_refs"><aside class="declaration">proc </aside>clear_overlay_refs<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/<a href="atom/movable/immerse_overlay.html">immerse_overlay</a>/source) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L365">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 365"/></a></aside>
        </h3>
        <p>We need to make sure to remove hard refs from the element when deleted.</p><h3 id="proc/generate_vis_overlay"><aside class="declaration">proc </aside>generate_vis_overlay<aside>(width, height, is_below_water) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L174">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 174"/></a></aside>
        </h3>
        <p>Let's give an unique immerse visual only to those movables that would
benefit from this the most, for the sake of a smidge of lightweightness.
Initializes and caches a new visual overlay given parameters such as width, height and whether it should appear fully underwater.</p><h3 id="proc/on_atom_exited"><aside class="declaration">proc </aside>on_atom_exited<aside>(/<a href="turf.html">turf</a>/source, /<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/exited, direction) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L293">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 293"/></a></aside>
        </h3>
        <p>Called when a movable exits the turf. If its new location is not in the list of turfs with this element,
Remove the movable from the element.</p><h3 id="proc/on_init_or_entered"><aside class="declaration">proc </aside>on_init_or_entered<aside>(/<a href="turf.html">turf</a>/source, /<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/movable) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L106">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 106"/></a></aside>
        </h3>
        <p>If the movable is within the right layers and planes, not in the list of movable types to ignore,
or already affected by the element for that matter, Signals will be registered and,
unless the movable (or whatever it's buckled to) is flying, it'll appear as if immersed in that water.</p><h3 id="proc/on_move_flag_disabled"><aside class="declaration">proc </aside>on_move_flag_disabled<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/source, flag, old_movement_type) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L272">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 272"/></a></aside>
        </h3>
        <p>Readds the overlay to the mob and bucklees if no longer flying.</p><h3 id="proc/on_move_flag_enabled"><aside class="declaration">proc </aside>on_move_flag_enabled<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/source, flag, old_movement_type) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L254">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 254"/></a></aside>
        </h3>
        <p>Removes the overlay from mob and bucklees is flying.</p><h3 id="proc/on_spin_animation"><aside class="declaration">proc </aside>on_spin_animation<aside>(/<a href="atom.html">atom</a>/source, speed, loops, segments, segment) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L359">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 359"/></a></aside>
        </h3>
        <p>Here, we temporarily switch from the offset of the mutable appearance to one for movable used as visual overlay.
Why? While visual overlays can be animated, their fixed point stays at the center of the icon of the atom
they're attached to and not theirs, which can make manipulating the transform var a pain, but because
we cannot do that with normal overlay or filters (reliably), we have to bend a knee and try to compensate it.
Oh, yeah, didn't I mention turning a visual overlay affects its pixel x/y/w/z too? Yeah, it sucks.
Spin the overlay in the opposite direction so it doesn't look like it's spinning at all.</p><h3 id="proc/on_throw"><aside class="declaration">proc </aside>on_throw<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/source) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L263">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 263"/></a></aside>
        </h3>
        <p>Works just like on_move_flag_enabled, except it only has to check that movable isn't flying</p><h3 id="proc/on_throw_landed"><aside class="declaration">proc </aside>on_throw_landed<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/source) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L281">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 281"/></a></aside>
        </h3>
        <p>Works just like on_move_flag_disabled, except it only has to check that movable isn't flying</p><h3 id="proc/on_update_transform"><aside class="declaration">proc </aside>on_update_transform<aside>(/<a href="mob.html">mob</a>/<a href="mob/living.html">living</a>/source, resize, new_lying_angle, is_opposite_angle) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L314">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 314"/></a></aside>
        </h3>
        <p>A band-aid to keep the (unique) visual overlay from scaling and rotating along with its owner. I'm sorry.</p><h3 id="proc/remove_from_element"><aside class="declaration">proc </aside>remove_from_element<aside>(/<a href="turf.html">turf</a>/source, /<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/movable) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L302">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 302"/></a></aside>
        </h3>
        <p>Remove any signal, overlay, trait given to the movable and reference to it within the element.</p><h3 id="proc/remove_immerse_overlay"><aside class="declaration">proc </aside>remove_immerse_overlay<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/movable) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L211">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 211"/></a></aside>
        </h3>
        <p>vis contents spin around the center of the icon of their vis locs
but since we want the appearance to stay where it should be,
we have to counteract this one.
This proc removes the vis_overlay, the keep together trait and some signals from the movable.</p><h3 id="proc/start_immersion"><aside class="declaration">proc </aside>start_immersion<aside>(/<a href="turf.html">turf</a>/source) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L85">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 85"/></a></aside>
        </h3>
        <p>Makes the element start affecting the turf and its contents. Called on Attach() or when TRAIT_IMMERSE_STOPPED is removed.</p><h3 id="proc/stop_immersion"><aside class="declaration">proc </aside>stop_immersion<aside>(/<a href="turf.html">turf</a>/source) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L94">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 94"/></a></aside>
        </h3>
        <p>Stops the element from affecting on the turf and its contents. Called on Detach() or when TRAIT_IMMERSE_STOPPED is added.</p><h3 id="proc/try_immerse"><aside class="declaration">proc </aside>try_immerse<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/movable, /<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/buckled) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L227">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 227"/></a></aside>
        </h3>
        <p>Called by init_or_entered() and on_set_buckled().
This applies the overlay if neither the movable or whatever is buckled to (exclusive to living mobs) are flying
as well as movetype signals when the movable isn't buckled.</p><h3 id="proc/try_unimmerse"><aside class="declaration">proc </aside>try_unimmerse<aside>(/<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/movable, /<a href="atom.html">atom</a>/<a href="atom/movable.html">movable</a>/buckled) 
        
    
            <a href="https://github.com/fulpstation/fulpstation/blob/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc/code/datums/elements/immerse.dm#L241">
        <img src="git.png" width="16" height="16" title="code&#x2F;datums&#x2F;elements&#x2F;immerse.dm 241"/></a></aside>
        </h3>
        <p>Called by on_set_buckled() and remove_from_element().
This removes the filter and signals from the movable unless it doesn't have them.</p></main>
<footer>
    tgstation.dme
    <a href="https://github.com/fulpstation/fulpstation/tree/629e2d40b55cd98862d1c91ccc4f04e9286e1fdc">629e2d4</a>
        (master) &mdash; <a href="https://github.com/SpaceManiac/SpacemanDMM/blob/master/crates/dmdoc/README.md">dmdoc 1.7.3</a></footer>
</body>
</html>
